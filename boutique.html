<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Biblioth√®que - Analyse Temps R√©el</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --primary-clr: #2d1b4e;
      --accent-clr: #d4af37;
      --secondary-clr: #f5f0e8;
      --text-clr: #1a1a1a;
      --light-clr: #ffffff;
      --success-clr: #2ecc71;
      --warning-clr: #f39c12;
      --info-clr: #3498db;
      --danger-clr: #e74c3c;
      --purple-clr: #9b59b6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Source Sans 3', sans-serif;
      background: linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%);
      color: var(--text-clr);
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 2px,
          rgba(0,0,0,0.01) 2px,
          rgba(0,0,0,0.01) 4px
        ),
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0,0,0,0.01) 2px,
          rgba(0,0,0,0.01) 4px
        );
      pointer-events: none;
      z-index: 1;
    }

    .navbar {
      background: linear-gradient(135deg, var(--primary-clr) 0%, #1a0f33 100%);
      box-shadow: 0 4px 20px rgba(45, 27, 78, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 3px solid var(--accent-clr);
    }

    .navbar-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--accent-clr);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      transition: transform 0.3s;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .logo i {
      color: var(--light-clr);
    }

    .nav-links {
      display: flex;
      gap: 2.5rem;
      list-style: none;
    }

    .nav-links a {
      color: var(--light-clr);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
      position: relative;
      padding: 0.5rem 0;
      letter-spacing: 0.5px;
    }

    .nav-links a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--accent-clr);
      transition: width 0.3s;
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2.5rem 20px;
      position: relative;
      z-index: 2;
    }

    .page-title {
      margin-bottom: 2.5rem;
      text-align: center;
    }

    .page-title h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 900;
      color: var(--primary-clr);
      margin-bottom: 1rem;
      letter-spacing: -1px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .page-title p {
      color: #666;
      font-size: 1.2rem;
      font-weight: 300;
    }

    /* Real-time badge */
    .realtime-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      background: linear-gradient(135deg, var(--success-clr), #27ae60);
      color: white;
      padding: 0.6rem 1.4rem;
      border-radius: 30px;
      font-size: 0.95rem;
      font-weight: 700;
      margin-left: 1rem;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
      animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .realtime-dot {
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      animation: pulse-dot 1.5s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.8rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--light-clr);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      border: 2px solid transparent;
    }

    /* Carte temps r√©el sp√©ciale */
    .stat-card.realtime {
      background: linear-gradient(135deg, #ffffff 0%, #f0fff4 100%);
      border: 2px solid var(--success-clr);
      grid-column: span 2;
    }

    .stat-card.realtime::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(46, 204, 113, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(50%, -50%);
    }

    .stat-card.realtime::after {
      content: 'LIVE';
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--success-clr);
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 900;
      letter-spacing: 1.5px;
      animation: blink 2s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      border-color: var(--accent-clr);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      opacity: 0.05;
      transform: translate(30%, -30%);
      transition: all 0.4s;
    }

    .stat-card.books::before { background: var(--primary-clr); }
    .stat-card.citations::before { background: var(--info-clr); }
    .stat-card.sorties::before { background: var(--success-clr); }
    .stat-card.money::before { background: var(--accent-clr); }
    .stat-card.time::before { background: var(--danger-clr); }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s;
    }

    .stat-card:hover .stat-icon {
      transform: rotate(-10deg) scale(1.1);
    }

    .stat-card.books .stat-icon {
      background: linear-gradient(135deg, var(--primary-clr), #4a2d7a);
    }

    .stat-card.citations .stat-icon {
      background: linear-gradient(135deg, var(--info-clr), #5dade2);
    }

    .stat-card.sorties .stat-icon {
      background: linear-gradient(135deg, var(--success-clr), #58d68d);
    }

    .stat-card.money .stat-icon {
      background: linear-gradient(135deg, var(--accent-clr), #f1c40f);
    }

    .stat-card.time .stat-icon {
      background: linear-gradient(135deg, var(--danger-clr), #ec7063);
    }

    .stat-trend {
      font-size: 0.95rem;
      padding: 0.4rem 0.9rem;
      border-radius: 25px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .stat-trend.up {
      background: rgba(46, 204, 113, 0.15);
      color: var(--success-clr);
    }

    .stat-trend.down {
      background: rgba(231, 76, 60, 0.15);
      color: var(--danger-clr);
    }

    .stat-body h3 {
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--primary-clr);
      margin-bottom: 0.6rem;
      letter-spacing: -1px;
    }

    .stat-subtitle {
      font-size: 0.9rem;
      color: #888;
      font-weight: 400;
    }

    /* Mini stats dans carte temps r√©el */
    .mini-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px dashed rgba(46, 204, 113, 0.2);
    }

    .mini-stat {
      text-align: center;
    }

    .mini-stat-label {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .mini-stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--success-clr);
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .chart-card {
      background: var(--light-clr);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      transition: all 0.3s;
    }

    .chart-card:hover {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .chart-header h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary-clr);
    }

    .chart-filter {
      display: flex;
      gap: 0.6rem;
    }

    .filter-btn {
      padding: 0.6rem 1.2rem;
      border: 2px solid var(--accent-clr);
      background: white;
      color: var(--primary-clr);
      border-radius: 25px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.5px;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: linear-gradient(135deg, var(--primary-clr), #4a2d7a);
      color: white;
      border-color: var(--primary-clr);
      transform: translateY(-2px);
    }

    .chart-container {
      position: relative;
      height: 350px;
    }

    /* Tables */
    .table-card {
      background: var(--light-clr);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      margin-bottom: 3rem;
      overflow-x: auto;
    }

    .table-card h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary-clr);
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    thead {
      background: linear-gradient(135deg, var(--primary-clr), #4a2d7a);
    }

    th {
      padding: 1.2rem;
      text-align: left;
      font-weight: 700;
      color: white;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.85rem;
    }

    td {
      padding: 1.2rem;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.95rem;
    }

    tbody tr {
      transition: all 0.3s;
    }

    tbody tr:hover {
      background: rgba(212, 175, 55, 0.05);
      transform: scale(1.01);
    }

    .badge {
      display: inline-block;
      padding: 0.4rem 1rem;
      border-radius: 25px;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .badge.success {
      background: rgba(46, 204, 113, 0.15);
      color: var(--success-clr);
    }

    .badge.warning {
      background: rgba(243, 156, 18, 0.15);
      color: var(--warning-clr);
    }

    .badge.danger {
      background: rgba(231, 76, 60, 0.15);
      color: var(--danger-clr);
    }

    /* Progress bar */
    .stock-progress {
      width: 100%;
      height: 10px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 0.6rem;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .stock-progress-bar {
      height: 100%;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }

    .stock-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255,255,255,0.3) 50%,
        transparent
      );
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .stock-progress-bar.high {
      background: linear-gradient(90deg, var(--success-clr), #27ae60);
    }

    .stock-progress-bar.medium {
      background: linear-gradient(90deg, var(--warning-clr), #f39c12);
    }

    .stock-progress-bar.low {
      background: linear-gradient(90deg, var(--danger-clr), #c0392b);
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--primary-clr);
    }

    .spinner {
      border: 4px solid rgba(45, 27, 78, 0.1);
      border-top: 4px solid var(--accent-clr);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 280px;
      }

      .realtime-badge {
        display: block;
        margin-left: 0;
        margin-top: 1rem;
        width: fit-content;
      }

      .mini-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-card.realtime {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <a href="/" class="logo">
        <i class="fas fa-book-open"></i>
        Bibliotheca
      </a>
      <ul class="nav-links">
        <li><a href="/">Accueil</a></li>
        <li><a href="ajout_livres.html">Entr√©es</a></li>
        <li><a href="sortie_livres.html">Sorties</a></li>
        <li><a href="resume_citation.html">R√©sum√©s</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="page-title">
      <h1>
        <i class="fas fa-chart-line" style="color: var(--accent-clr);"></i>
        Tableau de Bord Analytique
        <span class="realtime-badge">
          <span class="realtime-dot"></span>
          Mise √† jour automatique
        </span>
      </h1>
      <p>Vue d'ensemble en temps r√©el de votre biblioth√®que | Derni√®re mise √† jour : <span id="lastUpdate">0</span>s</p>
    </div>

    <div class="loading" id="loadingStats">
      <div class="spinner"></div>
      <p style="font-size: 1.1rem; font-weight: 600;">Chargement des statistiques...</p>
    </div>

    <div class="stats-grid" id="statsGrid" style="display: none;">
      <!-- CARTE STOCK EN TEMPS R√âEL -->
      <div class="stat-card realtime">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-warehouse"></i>
          </div>
          <span class="stat-trend up">
            <i class="fas fa-sync-alt fa-spin"></i> Temps R√©el
          </span>
        </div>
        <div class="stat-body">
          <h3>üìö Stock de Livres Disponibles</h3>
          <div class="stat-value" id="stockRestantTotal">0 exemplaires</div>
          <p class="stat-subtitle">Disponibles pour vente, pr√™t ou don</p>
          
          <div class="mini-stats">
            <div class="mini-stat">
              <div class="mini-stat-label">Total Titres</div>
              <div class="mini-stat-value" id="totalLivres">0</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-label">Sorties</div>
              <div class="mini-stat-value" id="totalSorties">0</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-label">√âpuis√©s</div>
              <div class="mini-stat-value" id="enRupture">0</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-label">Stock Faible</div>
              <div class="mini-stat-value" id="stockFaible">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Autres cartes stats - seront ajout√©es dynamiquement -->
    </div>

    <div class="charts-grid" id="chartsGrid" style="display: none;">
      <!-- Charts will be inserted here -->
    </div>

    <!-- NOUVEAU TABLEAU D√âTAILL√â PAR LIVRE -->
    <div class="table-card" id="detailedAnalysisCard" style="display: none;">
      <h3>
        <i class="fas fa-chart-bar"></i>
        Analyse D√©taill√©e par Livre (Stock Initial, Sorties, Disponible)
      </h3>
      <table id="bookAnalysisTable">
        <thead>
          <tr>
            <th>Livre</th>
            <th>Auteur</th>
            <th>Cat√©gorie</th>
            <th>Stock Initial</th>
            <th>Sorties Totales</th>
            <th>Stock Disponible</th>
            <th>Taux de Sortie</th>
            <th>Progression</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="8" style="text-align: center; padding: 3rem;">
              <div class="spinner" style="width: 40px; height: 40px;"></div>
              <p style="margin-top: 1rem; color: #666;">Chargement des donn√©es...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8040/api';
    let charts = {};
    let lastUpdateTime = 0;

    // ============================================================================
    // MISE √Ä JOUR DU TIMER
    // ============================================================================
    function updateTimer() {
      lastUpdateTime++;
      document.getElementById('lastUpdate').textContent = lastUpdateTime;
    }

    // ============================================================================
    // FORMATAGE DES NOMBRES
    // ============================================================================
    function formatNumber(num) {
      return num.toLocaleString('fr-FR');
    }

    // ============================================================================
    // CHARGEMENT DU STOCK EN TEMPS R√âEL
    // ============================================================================
    async function loadRealtimeStock() {
      try {
        // R√©cup√©rer tous les livres
        const booksResponse = await fetch(`${API_BASE_URL}/books`);
        const books = await booksResponse.json();

        // R√©cup√©rer toutes les sorties
        const sortiesResponse = await fetch(`${API_BASE_URL}/sorties`);
        const sorties = await sortiesResponse.json();

        // Calculer les totaux
        let stockInitialTotal = 0;
        let stockRestantTotal = 0;
        let totalLivres = books.length;
        let enRupture = 0;
        let stockFaible = 0;

        books.forEach(book => {
          const copies = book.copies_count || 0;
          stockRestantTotal += copies;

          // Calculer le stock initial (actuel + sorties)
          const sortiesLivre = sorties.filter(s => s.book_id === book.id)
            .reduce((sum, s) => sum + (s.quantity || 0), 0);
          stockInitialTotal += (copies + sortiesLivre);

          if (copies === 0) enRupture++;
          if (copies > 0 && copies <= 3) stockFaible++;
        });

        const totalSorties = sorties.length;

        // Mettre √† jour l'affichage
        document.getElementById('stockRestantTotal').textContent = `${formatNumber(stockRestantTotal)} exemplaires`;
        document.getElementById('totalLivres').textContent = formatNumber(totalLivres);
        document.getElementById('totalSorties').textContent = formatNumber(totalSorties);
        document.getElementById('enRupture').textContent = formatNumber(enRupture);
        document.getElementById('stockFaible').textContent = formatNumber(stockFaible);

        // R√©initialiser le timer
        lastUpdateTime = 0;
        document.getElementById('lastUpdate').textContent = '0';

      } catch (error) {
        console.error('‚ùå Erreur chargement stock temps r√©el:', error);
      }
    }

    // ============================================================================
    // CHARGEMENT DU TABLEAU D'ANALYSE D√âTAILL√âE
    // ============================================================================
    async function loadBookAnalysis() {
      try {
        // R√©cup√©rer tous les livres
        const booksResponse = await fetch(`${API_BASE_URL}/books`);
        const books = await booksResponse.json();

        // R√©cup√©rer toutes les sorties
        const sortiesResponse = await fetch(`${API_BASE_URL}/sorties`);
        const sorties = await sortiesResponse.json();

        // Grouper les sorties par livre
        const sortiesByBook = {};
        sorties.forEach(sortie => {
          if (!sortiesByBook[sortie.book_id]) {
            sortiesByBook[sortie.book_id] = 0;
          }
          sortiesByBook[sortie.book_id] += sortie.quantity || 1;
        });

        // Construire le tableau
        const tbody = document.querySelector('#bookAnalysisTable tbody');
        tbody.innerHTML = '';

        if (books.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 3rem;">Aucune donn√©e disponible</td></tr>';
          return;
        }

        books.forEach(book => {
          const stockDisponible = book.copies_count || 0;
          const sortiesTotal = sortiesByBook[book.id] || 0;
          const stockInitial = stockDisponible + sortiesTotal;
          
          const tauxSortie = stockInitial > 0 
            ? Math.round((sortiesTotal / stockInitial) * 100) 
            : 0;

          // D√©terminer la classe de la progression
          let progressClass = 'high';
          if (tauxSortie < 30) progressClass = 'low';
          else if (tauxSortie < 70) progressClass = 'medium';

          // D√©terminer le statut du stock
          let stockStatus = '';
          let stockBadge = '';
          if (stockDisponible === 0) {
            stockStatus = '√âpuis√©';
            stockBadge = 'danger';
          } else if (stockDisponible <= 3) {
            stockStatus = 'Faible';
            stockBadge = 'warning';
          } else {
            stockStatus = 'Disponible';
            stockBadge = 'success';
          }

          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${book.title}</strong></td>
            <td>${book.author}</td>
            <td><span style="color: var(--accent-clr); font-weight: 600;">${book.category || 'N/A'}</span></td>
            <td>${formatNumber(stockInitial)}</td>
            <td>${formatNumber(sortiesTotal)}</td>
            <td>
              <span class="badge ${stockBadge}">${formatNumber(stockDisponible)}</span>
              <small style="display: block; margin-top: 0.3rem; color: #888;">${stockStatus}</small>
            </td>
            <td><strong style="color: var(--primary-clr);">${tauxSortie}%</strong></td>
            <td>
              <div class="stock-progress">
                <div class="stock-progress-bar ${progressClass}" style="width: ${tauxSortie}%"></div>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });

      } catch (error) {
        console.error('‚ùå Erreur chargement analyse livres:', error);
      }
    }

    // ============================================================================
    // CHARGEMENT DU DASHBOARD
    // ============================================================================
    async function loadDashboard() {
      try {
        await Promise.all([
          loadStats(),
          loadCharts()
        ]);
        
        await loadRealtimeStock();
        await loadBookAnalysis();
        
        document.getElementById('loadingStats').style.display = 'none';
        document.getElementById('statsGrid').style.display = 'grid';
        document.getElementById('chartsGrid').style.display = 'grid';
        document.getElementById('detailedAnalysisCard').style.display = 'block';
      } catch (error) {
        console.error('Erreur chargement dashboard:', error);
        document.getElementById('loadingStats').innerHTML = `
          <p style="color: var(--danger-clr); font-size: 1.2rem; font-weight: 600;">Erreur de chargement des donn√©es</p>
          <p style="margin-top: 1rem; color: #666;">V√©rifiez que le serveur API est d√©marr√© sur le port 8040</p>
          <button onclick="loadDashboard()" style="margin-top: 1.5rem; padding: 0.8rem 2rem; background: var(--primary-clr); color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: 700; font-size: 1rem;">
            <i class="fas fa-redo"></i> R√©essayer
          </button>
        `;
      }
    }

    // ============================================================================
    // CHARGEMENT DES STATISTIQUES
    // ============================================================================
    async function loadStats() {
      const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
      const data = await response.json();
      
      const comparison = await fetch(`${API_BASE_URL}/dashboard/monthly-comparison`);
      const comp = await comparison.json();

      const statsGrid = document.getElementById('statsGrid');
      
      const additionalStats = `
        <div class="stat-card books">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-book"></i>
            </div>
            <span class="stat-trend ${comp.books.percentage >= 0 ? 'up' : 'down'}">
              <i class="fas fa-arrow-${comp.books.percentage >= 0 ? 'up' : 'down'}"></i> ${Math.abs(comp.books.percentage)}%
            </span>
          </div>
          <div class="stat-body">
            <h3>Total des Livres</h3>
            <div class="stat-value">${data.books.total}</div>
            <p class="stat-subtitle">+${data.books.this_month} ce mois-ci | ${data.books.total_copies} copies</p>
          </div>
        </div>

        <div class="stat-card citations">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-quote-right"></i>
            </div>
          </div>
          <div class="stat-body">
            <h3>Citations & R√©sum√©s</h3>
            <div class="stat-value">${data.citations.total + data.resumes.total}</div>
            <p class="stat-subtitle">${data.citations.total} citations | ${data.resumes.total} r√©sum√©s</p>
          </div>
        </div>

        <div class="stat-card sorties">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-exchange-alt"></i>
            </div>
            <span class="stat-trend ${comp.sorties.percentage >= 0 ? 'up' : 'down'}">
              <i class="fas fa-arrow-${comp.sorties.percentage >= 0 ? 'up' : 'down'}"></i> ${Math.abs(comp.sorties.percentage)}%
            </span>
          </div>
          <div class="stat-body">
            <h3>Sorties Totales</h3>
            <div class="stat-value">${data.sorties.total}</div>
            <p class="stat-subtitle">${data.sorties.ventes} ventes | ${data.sorties.prets} pr√™ts | ${data.sorties.dons} dons</p>
          </div>
        </div>

        <div class="stat-card money">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-coins"></i>
            </div>
            <span class="stat-trend ${comp.revenue.percentage >= 0 ? 'up' : 'down'}">
              <i class="fas fa-arrow-${comp.revenue.percentage >= 0 ? 'up' : 'down'}"></i> ${Math.abs(comp.revenue.percentage)}%
            </span>
          </div>
          <div class="stat-body">
            <h3>Revenus Totaux</h3>
            <div class="stat-value">${formatNumber(data.finance.revenue_total.toFixed(0))} F</div>
            <p class="stat-subtitle">${formatNumber(data.finance.revenue_this_month.toFixed(0))} F ce mois</p>
          </div>
        </div>

        <div class="stat-card time">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="stat-body">
            <h3>Temps de Lecture</h3>
            <div class="stat-value">${data.reading.estimated_hours}h</div>
            <p class="stat-subtitle">~${data.reading.estimated_days} jours | ${formatNumber(data.books.total_pages)} pages</p>
          </div>
        </div>

        <div class="stat-card books">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-star"></i>
            </div>
          </div>
          <div class="stat-body">
            <h3>Note Moyenne</h3>
            <div class="stat-value">${data.books.avg_rating}/5</div>
            <p class="stat-subtitle">Valeur totale: ${formatNumber(data.finance.total_invested.toFixed(0))} F</p>
          </div>
        </div>
      `;
      
      statsGrid.insertAdjacentHTML('beforeend', additionalStats);
    }

    // ============================================================================
    // CHARGEMENT DES GRAPHIQUES
    // ============================================================================
    async function loadCharts() {
      const chartsGrid = document.getElementById('chartsGrid');
      chartsGrid.innerHTML = `
        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-chart-bar"></i> √âvolution des Livres</h3>
            <div class="chart-filter">
              <button class="filter-btn active" onclick="loadBooksChart('year', this)">Ann√©e</button>
              <button class="filter-btn" onclick="loadBooksChart('month', this)">Mois</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="booksChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-chart-pie"></i> R√©partition par Cat√©gorie</h3>
          </div>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-chart-line"></i> √âvolution des Sorties</h3>
            <div class="chart-filter">
              <button class="filter-btn active" onclick="loadSortiesChart('year', this)">Ann√©e</button>
              <button class="filter-btn" onclick="loadSortiesChart('month', this)">Mois</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="sortiesChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-money-bill-wave"></i> Revenus Mensuels</h3>
            <div class="chart-filter">
              <button class="filter-btn active" onclick="loadRevenueChart('6months', this)">6 mois</button>
              <button class="filter-btn" onclick="loadRevenueChart('year', this)">1 an</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>
      `;

      await Promise.all([
        loadBooksChart('year'),
        loadCategoryChart(),
        loadSortiesChart('year'),
        loadRevenueChart('6months')
      ]);
    }

    async function loadBooksChart(period, clickedButton) {
      const response = await fetch(`${API_BASE_URL}/dashboard/books-evolution?period=${period}`);
      const data = await response.json();

      if (charts.books) charts.books.destroy();

      const ctx = document.getElementById('booksChart').getContext('2d');
      charts.books = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Livres ajout√©s',
            data: data.data,
            backgroundColor: 'rgba(45, 27, 78, 0.7)',
            borderColor: 'rgba(45, 27, 78, 1)',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      if (clickedButton) {
        const card = document.getElementById('booksChart').closest('.chart-card');
        card.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        clickedButton.classList.add('active');
      }
    }

    async function loadCategoryChart() {
      const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
      const data = await response.json();

      const ctx = document.getElementById('categoryChart').getContext('2d');
      charts.category = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.categories.map(c => c.name),
          datasets: [{
            data: data.categories.map(c => c.count),
            backgroundColor: [
              'rgba(45, 27, 78, 0.8)',
              'rgba(212, 175, 55, 0.8)',
              'rgba(46, 204, 113, 0.8)',
              'rgba(52, 152, 219, 0.8)',
              'rgba(231, 76, 60, 0.8)',
              'rgba(155, 89, 182, 0.8)',
              'rgba(243, 156, 18, 0.8)',
              'rgba(26, 188, 156, 0.8)'
            ],
            borderWidth: 3,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }

    async function loadSortiesChart(period, clickedButton) {
      const response = await fetch(`${API_BASE_URL}/dashboard/sorties-evolution?period=${period}`);
      const data = await response.json();

      if (charts.sorties) charts.sorties.destroy();

      const ctx = document.getElementById('sortiesChart').getContext('2d');
      charts.sorties = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [
            {
              label: 'Ventes',
              data: data.ventes,
              borderColor: 'rgba(46, 204, 113, 1)',
              backgroundColor: 'rgba(46, 204, 113, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Pr√™ts',
              data: data.prets,
              borderColor: 'rgba(52, 152, 219, 1)',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Dons',
              data: data.dons,
              borderColor: 'rgba(243, 156, 18, 1)',
              backgroundColor: 'rgba(243, 156, 18, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true } }
        }
      });

      if (clickedButton) {
        const card = document.getElementById('sortiesChart').closest('.chart-card');
        card.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        clickedButton.classList.add('active');
      }
    }

    async function loadRevenueChart(period, clickedButton) {
      const response = await fetch(`${API_BASE_URL}/dashboard/revenue-evolution?period=${period}`);
      const data = await response.json();

      if (charts.revenue) charts.revenue.destroy();

      const ctx = document.getElementById('revenueChart').getContext('2d');
      charts.revenue = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Revenus (FCFA)',
            data: data.data,
            backgroundColor: 'rgba(212, 175, 55, 0.2)',
            borderColor: 'rgba(212, 175, 55, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: value => formatNumber(value) + ' F' }
            }
          }
        }
      });

      if (clickedButton) {
        const card = document.getElementById('revenueChart').closest('.chart-card');
        card.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        clickedButton.classList.add('active');
      }
    }

    // ============================================================================
    // CHARGEMENT INITIAL ET MISES √Ä JOUR AUTOMATIQUES
    // ============================================================================
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Initialisation du dashboard...');
      
      loadDashboard();
      
      // Mettre √† jour le stock en temps r√©el toutes les 10 secondes
      setInterval(() => {
        console.log('üîÑ Rafra√Æchissement stock temps r√©el...');
        loadRealtimeStock();
        loadBookAnalysis();
      }, 10000);
      
      // Mettre √† jour le timer chaque seconde
      setInterval(updateTimer, 1000);
      
      // Rafra√Æchir le dashboard complet toutes les 5 minutes
      setInterval(() => {
        console.log('üîÑ Rafra√Æchissement complet du dashboard...');
        loadDashboard();
      }, 300000);
    });
  </script>
</body>
</html>